!function(e){function t(e,t){if(0!=e.b){if(x.alertResult){var n={id:+new Date,type:"result",user:{name:"System"},time:Math.floor(+new Date/1e3),result:e};A(n)}x.alertRecord&&(""!=e.sr||""!=e.ar)}}function n(){g.loading||(T.dispatch("LOADING_RESULTS"),v.send({type:"result",action:"fetch",params:{event:g.params.e,round:g.params.r,filter:g.params.filter}}))}function r(e){return R[e.e]}function s(e){return w[e.e][e.r]}function a(e){return E[e]||{}}function i(e){var t,n,r=999999999,a=0,i=!0,o=0,u=0,c=0,l=s(e),f=l.f,d="a"==f||""==f?5:"m"==f?3:parseInt(f);for(t=0;t<d;t++)n=e.v[t],c+=n,n>0&&n<r&&(r=n),0==n&&u++,n<0?(o++,a=n):n>a&&a>=0&&(a=n);e.b=r,999999999===e.b&&(e.b=0==a?0:-1),""==f&&(i=!1),("a"==f||"m"==f)&&u>0&&(i=!1),(o>1||1==o&&("m"==f||"3"==f))&&(i=!1),("1"==f||"2"==f||"3"==f&&"333bf"!=e.e)&&(i=!1),i?("m"==f||"3"==f?("333fm"===e.e&&(c*=100),e.a=Math.round(c/3)):e.a=Math.round((c-r-a)/3),e.a/100>600&&(e.a=100*Math.round(e.a/100))):"m"==f||"a"==f?e.a=u>0?0:-1:"333bf"!=e.event&&""!=f||(e.a=0)}function o(e,t,n,r,s){if("DNF"===e)return-1;if("DNS"===e)return-2;if(""===e)return 0;if("333fm"===t)return n?100*parseFloat(e):parseInt(e);if("333mbf"===t){var a=r-s,i=s-a;if(a>s||s<2)return-1;var o=e.match(/(?:(\d+)?:)?(\d{1,2})/);if(!o)return 0;var u=o[1]?parseInt(o[1]):0,c=parseInt(o[2]);return c=Math.min(60*u+c,600*Math.min(6,r)+2*s),1e7*(99-i)+100*c+a}var o=e.match(/(?:(\d+)?:)?(\d{1,2})\.(\d{1,2})/);if(!o)return 0;var u=o[1]?parseInt(o[1]):0,c=parseInt(o[2]),l=parseInt(o[3]);return 60*u+c>600&&(c+=l>50?1:0,l=0),100*(60*u+c)+l}function u(e,t){var n;if(0==e||void 0==e)return"";if(e=parseInt(e),e==-1)return"DNF";if(e==-2)return"DNS";if("333fm"===t)n=e>1e3?(e/100).toFixed(2):e+"";else if("333mbf"===t){var r=99-Math.floor(e/1e7),s=e%100;n=r+s+"/"+(r+2*s)+" "+c(Math.floor(e/100)%1e5,!0)}else{var a=e%100,i=Math.floor(e/100);a<10&&(a="0"+a),n=c(i)+"."+a}return n}function c(e,t){if(t&&99999==e)return"unknown";e=parseInt(e);var n=Math.floor(e/60),r=Math.floor(n/60);e%=60,n%=60;var s=[e];1==r&&(n+=60,r=0),r>0?s.push(n,r):(n>0||t)&&s.push(n);for(var a=1;a<s.length;a++)s[a-1]<10&&(s[a-1]="0"+s[a-1]);return s.reverse().join(":")}function l(e,t){for(var n,r,s=0,a=e.length-1;s<=a;)n=s+a>>1,r=d(t,e[n],!0),r<0?a=n-1:s=n+1;return s}function f(e,t){for(var n=0,r=e.length;n<r;n++)!e[n-1]||d(e[n-1],e[n],!0)<0?e[n].p=n+1:e[n].p=e[n-1].p,0==e[n].b&&(e[n].p="-"),e[n].isNew=e[n]===t}function d(e,t,n){var r=0,a=s(e);if("m"==a.f||"a"==a.f){if(e.a>0&&t.a<=0)return-1;if(t.a>0&&e.a<=0)return 1;r=e.a-t.a}if(0==r){if(e.b>0&&t.b<=0)return-1;if(t.b>0&&e.b<=0)return 1;r=e.b-t.b}return n||0!=r||(r=e.n-t.n),r}if(!("WS"in e))return void alert("Your browser doesn't support, please upgrade!");Vue.config.debug=!0;var m=$("#live-container"),p=m.data(),h=("https:"===location.protocol?"wss":"ws")+"://"+location.host+"/ws",v=new WS(h);v.threshold=55e3,v.on("connect",function(){v.send({type:"competition",competitionId:g.c}),0==g.results.length&&n(),v.send({type:"result",action:"rounds"}),x.showMessage&&v.send({type:"chat",action:"fetch"})}).on("*",function(e,t){t&&t.onlineNumber&&T.dispatch("UPDATE_ONLINE_NUMBER",t.onlineNumber)}).on("users",function(e){E=e}).on("result.new",function(e){T.dispatch("NEW_RESULT",e),t(e,"new")}).on("result.update",function(e){T.dispatch("UPDATE_RESULT",e),t(e,"update")}).on("result.all",function(e){T.dispatch("UPDATE_RESULTS",e)}).on("round.all",function(e){T.dispatch("UPDATE_ROUNDS",e)}).on("round.update",function(e){T.dispatch("UPDATE_ROUND",e)}).on("message.recent",function(e){x.showMessage&&T.dispatch("RECENT_MESSAGES",e)}).on("message.new",function(e){x.showMessage&&A(e)}).on("message.disable",function(e){x.disableChat=e}),Vue.use(VueRouter),Vue.use(Vuex),Vue.filter("decodeResult",u);var g={onlineNumber:0,user:{},c:0,events:[],filters:[],params:{event:"",round:"",filter:"all"},loading:!1,loadingUserResults:!1,results:[],userResults:[],messages:[],staticMessages:[]},b=Date.now(),R={},w={},E={},S={},N={CHANGE_PARAMS:function(e,t){e.params=t},UPDATE_ROUNDS:function(e,t){t.forEach(function(e){$.extend(w[e.e][e.i],e)}),b=Date.now()},UPDATE_ROUND:function(e,t){$.extend(w[t.e][t.i],t)},NEW_RESULT:function(e,t){if(t.c==e.c&&t.e==e.params.e&&t.r==e.params.r){t.p="",t.isNew=!0;var n=e.results,r=l(n,t);n.splice(r,0,t),f(n,t)}},UPDATE_RESULT:function(e,t){if(t.c==e.c&&t.e==e.params.e&&t.r==e.params.r){var n=e.results,r=0,s=n.length;for(t.p="",t.isNew=!0;r<s;r++)if(n[r].i==t.i){n[r]=t;break}n.sort(d),f(n,t)}},UPDATE_RESULTS:function(e,t){t.sort(d),f(t,{}),e.results=t,e.loading=!1},UPDATE_USER_RESULTS:function(e,t){e.userResults=t,e.loadingUserResults=!1},LOADING_RESULTS:function(e){e.loading=!0,e.results=[]},LOADING_USER_RESULTS:function(e){e.loadingUserResults=!0,e.userResults=[]},RECENT_MESSAGES:function(e,t){var n={};e.messages.forEach(function(e){n[e.id]=e.id}),t.forEach(function(t){t.type="normal",n[t.id]||e.messages.push(t)}),Vue.nextTick(function(){A({},!0)})},NEW_MESSAGE:function(e,t){(t.id||t.isSelf)&&(e.messages.push(t),e.messages.length>1e3&&e.messages.splice(0,1))},UPDATE_ONLINE_NUMBER:function(e,t){e.onlineNumber=t}};$.extend(g,p),p.liveStreamUrl&&g.staticMessages.push({id:+new Date,type:"static",user:{name:"System"},time:Math.floor(+new Date/1e3),content:'<a href="'+p.liveStreamUrl+'" target="_blank">'+p.liveStreamUrl+"</a>"});var x={enableEntry:!0,showMessage:!0,alertResult:!0,alertRecord:!0,disableChat:!1},D=window.store.get("live_options");D&&D.disableChat&&delete D.disableChat,$.extend(x,D),g.events.forEach(function(e){R[e.i]=e,w[e.i]={},e.rs.forEach(function(t){w[e.i][t.i]=t,S.e||2!=t.s||(S.e=e.i,S.r=t.i)})}),S.e||(S={e:g.params.e,r:g.params.r});var U={methods:{getRecordClass:function(e){return"NR"==e||"WR"==e?"record-"+e.toLowerCase():"record-cr"},getEventName:function(e){var t=r(e);return t&&t.name},getRoundName:function(e){var t=s(e);return t&&t.name},getUser:function(e){return a(e)},getResultDetail:function(e){var t,n,r=[];for(t=0;t<5;t++)n=u(e.v[t],e.e),n=(n+"            ").slice(0,"333mbo"===e.e||"333mbf"===e.e?13:8),r.push(n);return"<pre>"+r.join("   ")+"</pre>"}},vuex:{getters:{hasPermission:function(e){var t=e.user;return t.isOrganizer||t.isDelegate||t.isAdmin},eventName:function(e){var t=r(e.params);return t&&t.name},roundName:function(e){var t=s(e.params);return t&&t.name},events:function(e){return e.events},e:function(e){return e.params.e},r:function(e){return e.params.r},currentRound:function(e){return s(e.params)},isCurrentRoundOpen:function(e){var t=s(e.params);return 1!=t.s},results:function(e){return e.results},loading:function(e){return e.loading},userResults:function(e){return e.userResults},loadingUserResults:function(e){return e.loadingUserResults},filters:function(e){return e.filters},onlineNumber:function(e){return e.onlineNumber}}}},T=new Vuex.Store({state:g,strict:!0,mutations:N});Vue.mixin(U);var _=Vue.extend({template:"#live-container-template",store:T,data:function(){return{options:x,currentUser:{}}},watch:{"options.disableChat":function(e){v.send({type:"chat",action:"disable",disable_chat:e})},"options.enableEntry":function(){window.store.set("live_options",this.options)},"options.showMessage":function(){window.store.set("live_options",this.options)},"options.alertResult":function(){window.store.set("live_options",this.options)},"options.alertRecord":function(){window.store.set("live_options",this.options)}},methods:{showOptions:function(){$("#options-modal").modal()}},components:{chat:{props:["options"],data:function(){return{message:""}},vuex:{getters:{messages:function(e){return e.messages},staticMessages:function(e){return e.staticMessages}}},template:"#chat-template",methods:{send:function(e){var t=this;""!=t.message.trim()&&(v.send({type:"chat",action:"send",content:t.message,params:g.params}),A({user:g.user,content:t.message,isSelf:!0},!0),t.message="")}},components:{message:{props:["message"],template:"#message-template",filters:{formatTime:function(e){return e?moment(new Date(1e3*e)).format("MM-DD HH:mm:ss"):""}},components:{"static-message":{props:["message"],template:"#static-message-template"},"normal-message":{props:["message"],template:"#normal-message-template"},"result-message":{props:["message","result"],template:"#result-message-template"}}}}},result:{props:["options"],data:function(){return{eventRound:null,filter:"all",current:{v:[]},co:0,tl:0,f:"",n:0,page:1,limit:300}},computed:{offset:function(){return(this.page-1)*this.limit},totalPage:function(){return Math.ceil(this.results.length/this.limit)}},watch:{"$store.state.params":function(e){var t=this;t.eventRound={e:e.e,r:e.r},t.filter=e.filter,t.page=1;var n=s(e);t.co=n.co,t.tl=n.tl,t.n=n.n,t.f=n.f}},ready:function(){var e=this;e.eventRound={e:S.e,r:S.r};var t=s(e);e.co=t.co,e.tl=t.tl,e.n=t.n,e.f=t.f},template:"#result-template",methods:{hasAverage:function(e){var t=s(e||this);return"a"==t.f||"m"==t.f||"333bf"==t.e&&"3"==t.f},showRoundSettings:function(){$("#round-settings-modal").modal()},saveRoundSettings:function(){var e,t=this,n=["co","tl","n"];for(e=0;e<n.length;e++)if($("#"+n[e]).parent().removeClass("has-error"),isNaN(t[n[e]]))return void $("#"+n[e]).parent().addClass("has-error");return $("#f").parent().removeClass("has-error"),""==t.f?void $("#f").parent().addClass("has-error"):(v.send({type:"result",action:"round",round:{event:g.params.e,id:g.params.r,cut_off:t.co,time_limit:t.tl,format:t.f,number:t.n}}),void $("#round-settings-modal").modal("hide"))},closeRound:function(){this.current={v:[]},v.send({type:"result",action:"round",round:{event:g.params.e,id:g.params.r,status:1}}),n(),$("#round-settings-modal").modal("hide")},openRound:function(){v.send({type:"result",action:"round",round:{event:g.params.e,id:g.params.r,status:0}}),n(),$("#round-settings-modal").modal("hide")},exportScoreCard:function(){var e=$("#export-scord-card-form");e.find(".event").val(this.e),e.find(".round").val(this.r),e.submit()},resetCompetitors:function(){confirm("Do you want to reset competitors?")&&v.send({type:"result",action:"reset",round:{event:g.params.e,id:g.params.r}})},goToUser:function(e){this.$parent.currentUser=e,$("#user-results-modal").modal("show"),T.dispatch("LOADING_USER_RESULTS"),$.ajax({url:location.pathname+"/userResults",data:{user:e},dataType:"json",success:function(e){0==e.status&&T.dispatch("UPDATE_USER_RESULTS",e.data)}})},edit:function(e){this.hasPermission&&x.enableEntry&&this.isCurrentRoundOpen&&(this.current=JSON.parse(JSON.stringify(e)),this.$nextTick(function(){$(".input-panel-result input").eq(0).focus()}))},changeParams:function(){T.dispatch("CHANGE_PARAMS",{e:this.eventRound.e,r:this.eventRound.r,filter:this.filter}),Date.now()-b>3e5&&v.send({type:"result",action:"rounds"})},isAdvanced:function(e){if("all"!=this.filter)return!1;if("c"==e.r||"f"==e.r)return e.b>0&&e.p<=3;var t;for(t=0;t<R[e.e].rs.length;t++)if(R[e.e].rs[t].i==e.r&&R[e.e].rs[t+1])return e.b>0&&e.p<=R[e.e].rs[t+1].n;return!1}},components:{"input-panel":{props:["result"],data:function(){return{lastIndex:null,currentIndex:null,competitor:{name:""},v:[0,0,0,0,0],best:0,worst:0,average:0,searchText:"",searching:!1,selectedIndex:0}},computed:{competitors:function(){var e=this,t=e.searchText.toLowerCase();return e.results.filter(e.filterCompetitors.bind(e)).sort(function(e,n){if(!/^\d+$/.test(t)){var r=a(e.n).name.toLowerCase().indexOf(t)-a(n.n).name.toLowerCase().indexOf(t);return 0==r&&(r=a(e.n).name<a(n.n).name?-1:1),r}return e.n-n.n}).slice(0,5)}},watch:{round:function(){this.searchText=""},event:function(){this.searchText=""},result:function(e){var t=this;t.competitor=a(e.n),t.v=e.v,t.searchText=e.n||""},searchText:function(e){this.selectedIndex=0,""==e&&(this.result={v:[]})}},attached:function(){var e=this;$(window).on("resize",function(){e.$el.style.width=e.$el.parentNode.clientWidth-30+"px"}).trigger("resize")},methods:{isDisabled:function(e){var t=this,n=t.result;if(!n||!n.i||!this.$parent.isCurrentRoundOpen)return!0;var r=w[g.params.e][g.params.r];if(r.co>0){for(var s="a"==r.f?2:1,a=!1,i=0;i<s;i++)if(t.result.v[i]>0&&t.result.v[i]/100<r.co){a=!0;break}return!(a||e<s)}return!1},keydown:function(e){var t=e.which,n=this;switch(t){case 107:case 40:case 38:case 9:e.shiftKey||107==t||38==t?$(".result-input:not([disabled])").last().focus():$(".result-input:not([disabled])").first().focus();break;case 13:n.save()}},save:function(){var e=this;i(e.result),T.dispatch("UPDATE_RESULT",e.result);var t=e.result;v.send({type:"result",action:"update",result:{id:t.i,value1:t.v[0],value2:t.v[1],value3:t.v[2],value4:t.v[3],value5:t.v[4],best:t.b,average:t.a,regional_single_record:t.sr,regional_average_record:t.ar}}),e.result={v:[]},$("#input-panel-name").focus()},filterCompetitors:function(e){var t=this,n=t.searchText.trim();return""!=n&&(/^\d+$/.test(n)?!!e.n.toString().match(n):!!a(e.n).name.match(new RegExp(n,"i")))},enter:function(){this.competitors[this.selectedIndex]&&this.selectCompetitor(this.competitors[this.selectedIndex])},up:function(){var e=this.competitors.length;e&&(this.selectedIndex=(this.selectedIndex+e-1)%e)},down:function(){var e=this.competitors.length;e&&(this.selectedIndex=(this.selectedIndex+1)%e)},selectCompetitor:function(e){this.name=e.n,this.$parent.edit(e)}},vuex:{getters:{inputNum:function(e){var t=e.params,n=s(t),r=n&&n.f;switch(r){case"1":return 1;case"2":return 2;case"3":case"m":return 3;default:return 5}},minInputNum:function(e){var t=e.params,n=s(t),r=n&&n.f;switch(r){case"1":return 1;case"2":return 2;case"3":return 3;case"m":return 1;default:return 2}}}},template:"#input-panel-template",components:{"result-input":{props:["value","index"],data:function(){return{subIndex:2,tried:"",solved:"",time:""}},watch:{time:function(){this.calculateValue()},tried:function(){this.calculateValue()},solved:function(){this.calculateValue()},"$parent.result.i":function(){var e=this,t=u(e.value,e.e);if("333mbf"===e.e)if(e.subIndex=0,t.indexOf("/")>-1){var n=t.match(/^(\d+)\/(\d+) (.+)$/);e.solved=n[1],e.tried=n[2],e.time=n[3].replace(/[:\.]/g,"")}else e.solved=e.tried="",e.time=t;else e.time=t.replace(/[:\.]/g,""),e.subIndex=2}},methods:{calculateValue:function(){var e=this,t=s(e);e.value=o(e.formatTime(e.time),e.e,!1,e.tried,e.solved),t.tl>0&&"333mbf"!=e.e&&"333fm"!=e.e&&e.value/100>=t.tl&&(e.time="DNF"),"333fm"===e.e&&e.value>80&&(e.time="DNF")},formatTime:function(e){if("DNF"==e||"DNS"==e||""==e||"333fm"==this.e)return e;var t=e.length>4?parseInt(e.slice(0,-4)):0,n=e.length>2?parseInt(e.slice(0,-2).slice(-2)):0,r=parseInt(e.slice(-2));if("333mbf"===this.e){if(""==this.solved||""==this.tried)return"";t=n,n=r,r=0}return[t?t+":":"",n+".",r].join("")},focus:function(e){this.subIndex=e,this.$parent.currentIndex=this.index},blur:function(e){this.$parent.currentIndex=null,this.$parent.lastIndex=null},keydown:function(e,t){var n=e.which,r=this,s=r[t],a=r.$parent.lastIndex==r.$parent.currentIndex;switch(n){case 68:case 111:r.time="DNF";break;case 106:case 83:r.time="DNS";break;case 8:case 109:a&&"DNF"!=r.time&&"DNS"!=r.time||("DNF"!==r.time&&"DNS"!==r.time||(r.solved=r.tried=r.time=""),s=""),r.$parent.lastIndex=r.$parent.currentIndex,r[t]=s.slice(0,-1);break;case 107:case 38:case 9:if(e.shiftKey||107==n||38==n){var i=$(e.target),o=$(".result-input:not([disabled])"),u=o.index(i);u>0&&o.eq(u-1).focus();break}case 40:case 13:var i=$(e.target),o=$(".result-input:not([disabled])"),u=o.index(i);u<o.length-1?o.eq(u+1).focus():$("#save").focus();break;case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:n-=48;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(s.length>=6&&a)break;if(a&&"DNF"!=r.time&&"DNS"!=r.time||("DNF"!==r.time&&"DNS"!==r.time||(r.solved=r.tried=r.time=""),s=""),("333fm"===r.e||r.subIndex<2)&&s.length>=2)break;if("333mbf"===r.e&&s.length>=4)break;s+=n-48,r[t]=s,a||(r.$parent.lastIndex=r.$parent.currentIndex);break;default:e.preventDefault()}}},template:"#result-input-template"}}}}}}}),I=new VueRouter;I.map({"/event/:e/:r/:filter":{component:{}}}),T.watch(function(e){return e.params},function(e){I.go(["/event",e.e,e.r,e.filter].join("/")),n()},{deep:!0,sync:!0}),I.afterEach(function(e){var t=e.to.params;t.e==g.params.e&&t.r==g.params.r&&t.filter==g.params.filter||T.dispatch("CHANGE_PARAMS",t)}),I.redirect({"*":["/event",S.e,S.r,g.params.filter].join("/")}),I.start(_,m.get(0));var A=function(){var e=$(".message-container:not(.static-message-container)"),t=e.find("ul");return function(n,r){0==e.length&&(e=$(".message-container:not(.static-message-container)"),t=e.find("ul")),n.type=n.type||"normal",T.dispatch("NEW_MESSAGE",n),(r||e.height()+e.scrollTop()>t.height()-30)&&Vue.nextTick(function(){e.scrollTop(t.height())})}}()}(this);