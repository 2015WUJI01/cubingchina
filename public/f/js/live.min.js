!function(e){function t(e,t){if(t&&99999==e)return"unknown";e=parseInt(e);var n=Math.floor(e/60),s=Math.floor(n/60);e%=60,n%=60;var r=[e];s>0?r.push(n,s):n>0&&r.push(n);for(var o=1;o<r.length;o++)r[o-1]<10&&(r[o-1]="0"+r[o-1]);return r.reverse().join(":")}function n(e,t){for(var n,s,o=0,i=e.length-1;i>=o;)n=o+i>>1,s=r(t,e[n]),0>s?i=n-1:o=n+1;return o}function s(e,t){for(var n=0,s=e.length;s>n;n++)!e[n-1]||r(e[n-1],e[n])<0?e[n].pos=n+1:e[n].pos=e[n-1].pos,0==e[n].best&&(e[n].pos="-"),e[n].isNew=e[n]===t}function r(e,t){if(e.average>0&&t.average<=0)return-1;if(t.average>0&&e.average<=0)return 1;var n=e.average-t.average;if(0==n){if(e.best>0&&t.best<=0)return-1;if(t.best>0&&e.best<=0)return 1;n=e.best-t.best}return n}if(!("WS"in e))return void alert("Your browser doesn't support, please upgrade!");Vue.use(VueRouter),Vue.use(Vuex);var o=$("#live-container"),i=window.state={user:{},competitionId:0,events:{},event:"",round:"",results:[],messages:[]},u={CHANGE_EVENT:function(e,t){void 0!==e.events[t]&&(e.event=t,e.results=[],m.send({type:"result",command:"event",event:t}))},CHANGE_ROUND:function(e,t){e.events[e.event].indexOf(t)>-1&&(e.round=t,e.results=[],m.send({type:"result",command:"round",round:t}))},NEW_RESULT:function(e,t){if(t.competitionId==e.competitionId&&t.event==e.event&&t.round==e.round){t.pos="",t.isNew=!0;var r=e.results,o=n(r,t);r.splice(o,0,t),s(r,t)}},UPDATE_RESULT:function(e,t){if(t.competitionId==e.competitionId&&t.event==e.event&&t.round==e.round){var n=e.results,o=0,i=n.length;for(t.pos="",t.isNew=!0;i>o;o++)if(n[o].id==t.id){n[o]=t;break}n.sort(r),s(n,t)}},NEW_MESSAGE:function(e,t){e.messages.push(t),e.messages.length>1e3&&e.messages.splice(0,1)}};$.extend(i,o.data());var a=new Vuex.Store({state:i,mutations:u}),f=new Vue({el:o.get(0),template:$("#live-container-template").html(),store:a,components:{chat:Vue.extend({data:function(){return{message:""}},vuex:{getters:{messages:function(e){return e.messages}}},template:$("#chat-template").html(),methods:{send:function(e){var t=this;""!=t.message.trim()&&(m.send({type:"chat",content:t.message}),c({user:i.user,content:t.message,isSelf:!0},!0),t.message="")}},components:{message:Vue.extend({props:["message"],template:$("#message-template").html(),filters:{formatTime:function(e){return e?moment(new Date(1e3*e)).format("HH:mm:ss"):""}}})}}),result:Vue.extend({vuex:{getters:{results:function(e){return e.results}}},template:$("#result-template").html(),filters:{formatTime:function(e,n){var s;if(e=parseInt(e),-1==e)return"DNF";if(-2==e)return"DNS";if(0==e)return"";if("333fm"===n)s=e>1e3?(e/100).toFixed(2):e;else if("333mbf"===n){var r=99-Math.floor(e/1e7),o=e%100;s=r+o+"/"+(r+2*o)+" "+t(Math.floor(e/100)%1e5,!0)}else{var i=e%100,u=Math.floor(e/100);10>i&&(i="0"+i),s=t(u)+"."+i}return s}}})}}),m=new WS("ws://"+location.host+"/ws");m.on("connect",function(){m.send({type:"competition",competitionId:i.competitionId})}).on("newresult",function(e){a.dispatch("NEW_RESULT",e)}).on("newmessage",function(e){c(e)});var c=function(){var e=$(".message-container"),t=e.find("ul");return function(n,s){a.dispatch("NEW_MESSAGE",n),(s||e.height()+e.scrollTop()>t.height())&&f.$nextTick(function(){e.scrollTop(t.height())})}}()}(this);