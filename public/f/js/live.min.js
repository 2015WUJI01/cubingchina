!function(e){function t(e,t){var a={user:{name:"System"},time:Math.floor(+new Date/1e3)},n=[],r=[];r.push(e.user.name),r.push(h[e.event]&&h[e.event].name),r.push(f[e.event]&&f[e.event][e.round]&&f[e.event][e.round].name),n.push(r.join(" - ")),0!=e.average&&n.push("Average: "+s(e.average,e.event)),n.push("Single: "+s(e.best,e.event)),r=[];for(var u=1;5>=u;u++)0!=e["value"+u]&&r.push(s(e["value"+u],e.event));n.push("Detail: "+r.join("    ")),a.content='<p class="text-danger">'+n.join("<br>")+"</p>",A(a)}function a(){p.loading||(p.loading=!0,p.results=[],l.send({type:"result",action:"fetch",params:p.params}))}function n(e){var t,a,n=999999999,r=0,s=!0,u=0,i=0;for(t=1;5>=t;t++)a=e["value"+t],i+=a,a>0&&n>a&&(n=a),0>a?(u++,r=a):a>0&&a>r&&(r=a),e.best=n,"a"!=e.format&&"m"!=e.format||0!=e.value3||(s=!1),(u>1||1==u&&"m"==e.format)&&(s=!1),"1"!=e.format&&"2"!=e.format&&"3"!=e.format||(s=!1),s&&("m"==e.format?e.average=Math.round(i):e.average=Math.round((i-n-r)/5))}function r(e,t,a){if("DNF"===e)return-1;if("DNS"===e)return-2;if(""===e)return 0;if("333fm"===t)return a?100*parseFloat(e):parseInt(e);if("333mbf"!==t){var n=e.match(/(?:(\d+)?:)?(\d{1,2})\.(\d{1,2})/);if(!n)return 0;var r=n[1]?parseInt(n[1]):0,s=parseInt(n[2]),u=parseInt(n[3])*(1==n[3].length?10:1);return 100*(60*r+s)+u}}function s(e,t){var a;if(e=parseInt(e),-1==e)return"DNF";if(-2==e)return"DNS";if(0==e)return"";if("333fm"===t)a=e>1e3?(e/100).toFixed(2):e;else if("333mbf"===t){var n=99-Math.floor(e/1e7),r=e%100;a=n+r+"/"+(n+2*r)+" "+u(Math.floor(e/100)%1e5,!0)}else{var s=e%100,i=Math.floor(e/100);10>s&&(s="0"+s),a=u(i)+"."+s}return a}function u(e,t){if(t&&99999==e)return"unknown";e=parseInt(e);var a=Math.floor(e/60),n=Math.floor(a/60);e%=60,a%=60;var r=[e];n>0?r.push(a,n):a>0&&r.push(a);for(var s=1;s<r.length;s++)r[s-1]<10&&(r[s-1]="0"+r[s-1]);return r.reverse().join(":")}function i(e,t){for(var a,n,r=0,s=e.length-1;s>=r;)a=r+s>>1,n=c(t,e[a],!0),0>n?s=a-1:r=a+1;return r}function o(e,t){for(var a=0,n=e.length;n>a;a++)!e[a-1]||c(e[a-1],e[a],!0)<0?e[a].pos=a+1:e[a].pos=e[a-1].pos,0==e[a].best&&(e[a].pos="-"),e[a].isNew=e[a]===t}function c(e,t,a){if(e.average>0&&t.average<=0)return-1;if(t.average>0&&e.average<=0)return 1;var n=e.average-t.average;if(0==n){if(e.best>0&&t.best<=0)return-1;if(t.best>0&&e.best<=0)return 1;n=e.best-t.best}return a||0!=n||(n=e.user.name<t.user.name?-1:1),n}if(!("WS"in e))return void alert("Your browser doesn't support, please upgrade!");Vue.config.debug=!0;var l=new WS("ws://"+location.host+"/ws");l.on("connect",function(){l.send({type:"competition",competitionId:p.competitionId}),a()}).on("result.new",function(e){d.dispatch("NEW_RESULT",e),t(e,"new")}).on("result.update",function(e){d.dispatch("UPDATE_RESULT",e),t(e,"update")}).on("message.new",function(e){A(e)}).on("result.all",function(e){d.dispatch("UPDATE_RESULTS",e)}),Vue.use(VueRouter),Vue.use(Vuex);var v=$("#live-container"),p={user:{},competitionId:0,events:[],params:{event:"",round:""},loading:!1,results:[],messages:[]},h={},f={},m={CHANGE_EVENT_ROUND:function(e,t){e.params=t},NEW_RESULT:function(e,t){if(t.competitionId==e.competitionId&&t.event==e.params.event&&t.round==e.params.round){t.pos="",t.isNew=!0;var a=e.results,n=i(a,t);a.splice(n,0,t),o(a,t)}},UPDATE_RESULT:function(e,t){if(t.competitionId==e.competitionId&&t.event==e.params.event&&t.round==e.params.round){var a=e.results,n=0,r=a.length;for(t.pos="",t.isNew=!0;r>n;n++)if(a[n].id==t.id){t.user=a[n].user,a[n]=t;break}a.sort(c),o(a,t)}},UPDATE_RESULTS:function(e,t){t.sort(c),o(t,{}),e.results=t,e.loading=!1},NEW_MESSAGE:function(e,t){e.messages.push(t),e.messages.length>1e3&&e.messages.splice(0,1)}};$.extend(p,v.data()),p.events.forEach(function(e){h[e.id]=e,f[e.id]={},e.rounds.forEach(function(t){f[e.id][t.id]=t})});var d=new Vuex.Store({state:p,mutations:m}),g=Vue.extend({template:"#live-container-template",store:d,components:{chat:{data:function(){return{message:""}},vuex:{getters:{messages:function(e){return e.messages}}},template:"#chat-template",methods:{send:function(e){var t=this;""!=t.message.trim()&&(l.send({type:"chat",content:t.message}),A({user:p.user,content:t.message,isSelf:!0},!0),t.message="")}},components:{message:{props:["message"],template:"#message-template",filters:{formatTime:function(e){return e?moment(new Date(1e3*e)).format("HH:mm:ss"):""}}}}},result:{data:function(){return{eventRound:null,current:null}},watch:{"$store.state.params":function(e){this.eventRound={event:e.event,round:e.round}}},vuex:{getters:{hasPermission:function(e){var t=e.user;return t.isOrganizer||t.isDelegate||t.isAdmin},eventName:function(e){return h[e.params.event]&&h[e.params.event].name},roundName:function(e){var t=e.params;return f[t.event]&&f[t.event][t.round]?f[t.event][t.round].name:void 0},loading:function(e){return e.loading},event:function(e){return e.params.event},round:function(e){return e.params.round},events:function(e){return e.events},results:function(e){return e.results}}},template:"#result-template",methods:{click:function(e){this.hasPermission&&(this.current=e)},changeEventRound:function(){d.dispatch("CHANGE_EVENT_ROUND",{event:this.eventRound.event,round:this.eventRound.round})}},filters:{decodeResult:function(e,t){return s(e,t)}},components:{"input-panel":{props:["result"],data:function(){return{lastInput:null,inputNames:["value1","value2","value3","value4","value5"],competitor:{name:""},value:{value1:0,value2:0,value3:0,value4:0,value5:0},best:0,worst:0,average:0}},watch:{result:function(e){this.competitor.name=e.user&&e.user.name,this.value.value1=e.value1||0,this.value.value2=e.value2||0,this.value.value3=e.value3||0,this.value.value4=e.value4||0,this.value.value5=e.value5||0}},attached:function(){this.$el.style.width=this.$el.clientWidth+"px"},methods:{formatResult:function(e){if("DNF"==e||"DNS"==e||""==e)return e;var t=e.match(/(?:(\d+)?:)?(?:(\d{1,2})\.)?(\d{1,})?/),a=t[1]?parseInt(t[1]):0,n=t[2]?parseInt(t[2]):0,r=t[3]?parseInt(t[3])*(1==t[3].length?10:1):0;return s(100*(60*a+n)+r,p.params.event)},save:function(){var e,t=$(".input-panel-result").find(".input-group").removeClass("has-error").find("input");for(e=1;e<=this.inputNum&&(e!=this.minInputNum+1||0!=this.value["value"+e]);e++)if(0==this.value["value"+e])return void t.eq(e-1).parent().addClass("has-error");this.result.value1=this.value.value1,this.result.value2=this.value.value2,this.result.value3=this.value.value3,this.result.value4=this.value.value4,this.result.value5=this.value.value5,n(this.result),d.dispatch("UPDATE_RESULT",this.result),l.send({type:"result",action:"update",result:this.result}),this.result={}},focus:function(e,t){this.lastInput=t,$(e.target).removeClass("has-error")},blur:function(e){e.target.value=this.formatResult(e.target.value),this.value[this.lastInput]=r(e.target.value)},keydown:function(e){var t=e.which,a=e.target.value;switch(console.log(e),t){case 68:case 111:this.value[this.lastInput]=-1;break;case 106:case 83:this.value[this.lastInput]=-2;break;case 8:this.value[this.lastInput]=0,e.target.value="";break;case 9:if(e.shiftKey){var n=$(e.target).parent(),r=n.index();r>0&&n.prev().find("input").focus();break}case 13:if(""==e.target.value)break;var n=$(e.target).parent(),r=n.index();r<this.inputNum-1?n.next().find("input").focus():n.parent().next().focus();break;case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:t-=48;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(a.length>=8)break;switch(a=a.replace(/^0./,""),a=a.replace(/:|\./g,""),a+=t-48,a.length){case 1:case 2:break;case 3:a=a.charAt(0)+"."+a.charAt(1)+a.charAt(2);break;case 4:a=a.charAt(0)+a.charAt(1)+"."+a.charAt(2)+a.charAt(3);break;case 5:a=a.charAt(0)+":"+a.charAt(1)+a.charAt(2)+"."+a.charAt(3)+a.charAt(4);break;case 6:a=a.charAt(0)+a.charAt(1)+":"+a.charAt(2)+a.charAt(3)+"."+a.charAt(4)+a.charAt(5)}e.target.value=a;break}}},vuex:{getters:{inputNum:function(e){var t=e.params,a=f[t.event]&&f[t.event][t.round],n=a&&a.format;switch(n){case"1":return 1;case"2":return 2;case"3":case"m":return 3;default:return 5}},minInputNum:function(e){var t=e.params,a=f[t.event]&&f[t.event][t.round],n=a&&a.format;switch(n){case"1":return 1;case"2":return 2;case"3":return 3;case"m":return 1;default:return 2}}}},filters:{result:{read:function(e){return s(e,p.params.event)},write:function(e){return r(e,p.params.event)}}},template:"#input-panel-template"}}}}}),E=new VueRouter;E.map({"/:event/:round":{component:{}}}),d.watch(function(e){return e.params},function(e){E.go(["",e.event,e.round].join("/")),a()},{deep:!0,sync:!0}),E.afterEach(function(e){var t=e.to.params;t.event==p.params.event&&t.round==p.params.round||d.dispatch("CHANGE_EVENT_ROUND",t)}),E.redirect({"*":["",p.params.event,p.params.round].join("/")}),E.start(g,v.get(0));var A=function(){var e=$(".message-container"),t=e.find("ul");return function(a,n){d.dispatch("NEW_MESSAGE",a),(n||e.height()+e.scrollTop()>t.height())&&Vue.nextTick(function(){e.scrollTop(t.height())})}}()}(this);