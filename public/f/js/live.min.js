!function(e){function t(e,t){var n=$(".message-container"),r=n.find("ul");E.dispatch("NEW_MESSAGE",e),(t||n.height()+n.scrollTop()>r.height()-30)&&Vue.nextTick(function(){n.scrollTop(r.height())})}function n(e,n){if(0!=e.best){if(b.alertResult){var r={id:+new Date,user:{name:"System"},time:Math.floor(+new Date/1e3)},s=[],a=[];a.push(e.user.name),a.push(p[e.event]&&p[e.event].name),a.push(v[e.event]&&v[e.event][e.round]&&v[e.event][e.round].name),s.push(a.join(" - ")),0!=e.average&&s.push("Average: "+i(e.average,e.event)),s.push("Single: "+i(e.best,e.event)),a=[];for(var o="a"==e.format?5:"m"==e.format?3:parseInt(e.format),u=1;o>=u;u++)0!=e["value"+u]?a.push(i(e["value"+u],e.event)):a.push("--");s.push("Detail: "+a.join("    ")),r.content='<p class="text-danger">'+s.join("<br>")+"</p>",t(r)}b.alertRecord&&(""!=e.regional_single_record||""!=e.regional_average_record)}}function r(){m.loading||(E.dispatch("LOADING_RESULTS"),d.send({type:"result",action:"fetch",params:m.params}))}function s(e){var t,n,r=999999999,s=0,a=!0,i=0,o=0,u=0,c="a"==e.format?5:"m"==e.format?3:parseInt(e.format);for(t=1;c>=t;t++)n=e["value"+t],u+=n,n>0&&r>n&&(r=n),0==n&&o++,0>n?(i++,s=n):n>s&&s>=0&&(s=n);e.best=r,999999999===e.best&&(e.best=0==s?0:-1),("a"==e.format||"m"==e.format)&&o>0&&(a=!1),(i>1||1==i&&("m"==e.format||"3"==e.format))&&(a=!1),("1"==e.format||"2"==e.format||"3"==e.format&&"333bf"!=e.event)&&(a=!1),a?"m"==e.format||"3"==e.format?("333fm"===e.event&&(u*=100),e.average=Math.round(u/3)):e.average=Math.round((u-r-s)/3):"m"==e.format||"a"==e.format?e.average=o>0?0:-1:"333bf"==e.event&&(e.average=0)}function a(e,t,n,r,s){if("DNF"===e)return-1;if("DNS"===e)return-2;if(""===e)return 0;if("333fm"===t)return n?100*parseFloat(e):parseInt(e);if("333mbf"===t){var a=r-s,i=s-a;if(a>s||2>s)return-1;var o=e.match(/(?:(\d+)?:)?(\d{1,2})/);if(!o)return 0;var u=o[1]?parseInt(o[1]):0,c=parseInt(o[2]);return c=Math.min(60*u+c,600*Math.min(6,r)),1e7*(99-i)+100*c+a}var o=e.match(/(?:(\d+)?:)?(\d{1,2})\.(\d{1,2})/);if(!o)return 0;var u=o[1]?parseInt(o[1]):0,c=parseInt(o[2]),l=parseInt(o[3]);return 100*(60*u+c)+l}function i(e,t){var n;if(0==e||void 0==e)return"";if(e=parseInt(e),-1==e)return"DNF";if(-2==e)return"DNS";if("333fm"===t)n=e>1e3?(e/100).toFixed(2):e+"";else if("333mbf"===t){var r=99-Math.floor(e/1e7),s=e%100;n=r+s+"/"+(r+2*s)+" "+o(Math.floor(e/100)%1e5,!0)}else{var a=e%100,i=Math.floor(e/100);10>a&&(a="0"+a),n=o(i)+"."+a}return n}function o(e,t){if(t&&99999==e)return"unknown";e=parseInt(e);var n=Math.floor(e/60),r=Math.floor(n/60);e%=60,n%=60;var s=[e];1==r&&(n+=60,r=0),r>0?s.push(n,r):n>0&&s.push(n);for(var a=1;a<s.length;a++)s[a-1]<10&&(s[a-1]="0"+s[a-1]);return s.reverse().join(":")}function u(e,t){for(var n,r,s=0,a=e.length-1;a>=s;)n=s+a>>1,r=l(t,e[n],!0),0>r?a=n-1:s=n+1;return s}function c(e,t){for(var n=0,r=e.length;r>n;n++)!e[n-1]||l(e[n-1],e[n],!0)<0?e[n].pos=n+1:e[n].pos=e[n-1].pos,0==e[n].best&&(e[n].pos="-"),e[n].isNew=e[n]===t}function l(e,t,n){var r=0;if("m"==e.format||"a"==e.format){if(e.average>0&&t.average<=0)return-1;if(t.average>0&&e.average<=0)return 1;r=e.average-t.average}if(0==r){if(e.best>0&&t.best<=0)return-1;if(t.best>0&&e.best<=0)return 1;r=e.best-t.best}return n||0!=r||(r=e.user.name<t.user.name?-1:1),r}if(!("WS"in e))return void alert("Your browser doesn't support, please upgrade!");var d=window._ws=new WS("ws://"+location.host+"/ws");d.on("connect",function(){d.send({type:"competition",competitionId:m.competitionId}),0==m.results.length&&r(),d.send({type:"result",action:"rounds"}),b.showMessage&&d.send({type:"chat",action:"fetch"})}).on("receive",function(e){e.onlineNumber&&E.dispatch("UPDATE_ONLINE_NUMBER",e.onlineNumber)}).on("result.new",function(e){E.dispatch("NEW_RESULT",e),n(e,"new")}).on("result.update",function(e){E.dispatch("UPDATE_RESULT",e),n(e,"update")}).on("result.user",function(e){E.dispatch("UPDATE_USER_RESULTS",e)}).on("result.all",function(e){E.dispatch("UPDATE_RESULTS",e)}).on("round.all",function(e){E.dispatch("UPDATE_ROUNDS",e)}).on("round.update",function(e){E.dispatch("UPDATE_ROUND",e)}).on("message.recent",function(e){b.showMessage&&E.dispatch("RECENT_MESSAGES",e)}).on("message.new",function(e){b.showMessage&&t(e)}),Vue.use(VueRouter),Vue.use(Vuex),Vue.filter("decodeResult",i);var f=$("#live-container"),m={onlineNumber:0,user:{},competitionId:0,events:[],filters:[],params:{event:"",round:"",filter:"all"},loading:!1,loadingUserResults:!1,results:[],userResults:[],messages:[]},p={},v={},h={},g={CHANGE_PARAMS:function(e,t){e.params=t},UPDATE_ROUNDS:function(e,t){t.forEach(function(e){$.extend(v[e.event][e.id],e)})},UPDATE_ROUND:function(e,t){$.extend(v[t.event][t.id],t)},NEW_RESULT:function(e,t){if(t.competitionId==e.competitionId&&t.event==e.params.event&&t.round==e.params.round){t.pos="",t.isNew=!0;var n=e.results,r=u(n,t);n.splice(r,0,t),c(n,t)}},UPDATE_RESULT:function(e,t){if(t.competitionId==e.competitionId&&t.event==e.params.event&&t.round==e.params.round){var n=e.results,r=0,s=n.length;for(t.pos="",t.isNew=!0;s>r;r++)if(n[r].id==t.id){t.user=n[r].user,n[r]=t;break}n.sort(l),c(n,t)}},UPDATE_RESULTS:function(e,t){t.sort(l),c(t,{}),e.results=t,e.loading=!1},UPDATE_USER_RESULTS:function(e,t){e.userResults=t,e.loadingUserResults=!1},LOADING_RESULTS:function(e){e.loading=!0,e.results=[]},LOADING_USER_RESULTS:function(e){e.loadingUserResults=!0,e.userResults=[]},RECENT_MESSAGES:function(e,n){var r={};e.messages.forEach(function(e){r[e.id]=e.id}),n.forEach(function(t){r[t.id]||e.messages.push(t)}),Vue.nextTick(function(){t({},!0)})},NEW_MESSAGE:function(e,t){(t.id||t.isSelf)&&(e.messages.push(t),e.messages.length>1e3&&e.messages.splice(0,1))},UPDATE_ONLINE_NUMBER:function(e,t){e.onlineNumber=t}};$.extend(m,f.data());var b={enableEntry:!0,showMessage:!0,alertResult:!0,alertRecord:!0};$.extend(b,window.store.get("live_options")),m.events.forEach(function(e){p[e.id]=e,v[e.id]={},e.rounds.forEach(function(t){v[e.id][t.id]=t,h.event||2!=t.status||(h.event=e.id,h.round=t.id)})}),h.event||(h={event:m.params.event,round:m.params.round});var R={vuex:{getters:{hasPermission:function(e){var t=e.user;return t.isOrganizer||t.isDelegate||t.isAdmin},eventName:function(e){return p[e.params.event]&&p[e.params.event].name},roundName:function(e){var t=e.params;return v[t.event]&&v[t.event][t.round]?v[t.event][t.round].name:void 0},events:function(e){return e.events},event:function(e){return e.params.event},round:function(e){return e.params.round},isCurrentRoundOpen:function(e){var t=v[e.params.event][e.params.round];return 1!=t.status},results:function(e){return e.results},loading:function(e){return e.loading},userResults:function(e){return e.userResults},loadingUserResults:function(e){return e.loadingUserResults},filters:function(e){return e.filters},onlineNumber:function(e){return e.onlineNumber}}}},E=new Vuex.Store({state:m,mutations:g});Vue.mixin(R);var w=Vue.extend({template:"#live-container-template",store:E,data:function(){return{options:b,currentUser:{}}},watch:{"options.enableEntry":function(){window.store.set("live_options",this.options)},"options.showMessage":function(){window.store.set("live_options",this.options)},"options.alertResult":function(){window.store.set("live_options",this.options)},"options.alertRecord":function(){window.store.set("live_options",this.options)}},methods:{getRecordClass:function(e){return"NR"==e||"WR"==e?"record-"+e.toLowerCase():"record-cr"},getEventName:function(e){return p[e]&&p[e].name},getRoundName:function(e,t){return v[e][t]&&v[e][t].name},showOptions:function(){$("#options-modal").modal()}},components:{chat:{props:["options"],data:function(){return{message:""}},vuex:{getters:{messages:function(e){return e.messages}}},template:"#chat-template",methods:{send:function(e){var n=this;""!=n.message.trim()&&(d.send({type:"chat",action:"send",content:n.message,params:m.params}),t({user:m.user,content:n.message,isSelf:!0},!0),n.message="")}},components:{message:{props:["message"],template:"#message-template",filters:{formatTime:function(e){return e?moment(new Date(1e3*e)).format("HH:mm:ss"):""}}}}},result:{props:["options"],data:function(){return{eventRound:null,filter:"all",current:{},cut_off:0,time_limit:0,number:0,page:1,limit:300}},computed:{offset:function(){return(this.page-1)*this.limit},totalPage:function(){return Math.ceil(this.results.length/this.limit)}},watch:{"$store.state.params":function(e){var t=this;t.eventRound={event:e.event,round:e.round},t.filter=e.filter,t.page=1;var n=v[e.event][e.round];t.cut_off=n.cut_off,t.time_limit=n.time_limit,t.number=n.number}},ready:function(){this.eventRound={event:h.event,round:h.round}},template:"#result-template",methods:{hasAverage:function(e){var t=e||v[this.event][this.round];return"a"==t.format||"m"==t.format||"333bf"==this.event&&"3"==t.format},getRecordClass:function(e){return"NR"==e||"WR"==e?"record-"+e.toLowerCase():"record-cr"},showRoundSettings:function(){$("#round-settings-modal").modal()},saveRoundSettings:function(){var e,t=this,n=["cut_off","time_limit","number"];for(e=0;e<n.length;e++)if($("#"+n[e]).parent().removeClass("has-error"),isNaN(t[n[e]]))return void $("#"+n[e]).parent().addClass("has-error");d.send({type:"result",action:"round",round:{event:m.params.event,id:m.params.round,cut_off:t.cut_off,time_limit:t.time_limit,number:t.number}}),$("#round-settings-modal").modal("hide")},closeRound:function(){this.current={},d.send({type:"result",action:"round",round:{event:m.params.event,id:m.params.round,status:1}}),$("#round-settings-modal").modal("hide")},openRound:function(){d.send({type:"result",action:"round",round:{event:m.params.event,id:m.params.round,status:0}}),$("#round-settings-modal").modal("hide")},resetCompetitors:function(){(0==this.results.length||confirm("Do you want reset competitors?"))&&d.send({type:"result",action:"reset",round:{event:m.params.event,id:m.params.round}})},goToUser:function(e){this.$parent.currentUser=e,$("#user-results-modal").modal("show"),E.dispatch("LOADING_USER_RESULTS"),d.send({type:"result",action:"user",user:e})},edit:function(e){this.hasPermission&&b.enableEntry&&this.isCurrentRoundOpen&&(this.current=$.extend({},e),this.$nextTick(function(){$(".input-panel-result input").eq(0).focus()}))},changeParams:function(){E.dispatch("CHANGE_PARAMS",{event:this.eventRound.event,round:this.eventRound.round,filter:this.filter})},isAdvanced:function(e){if("all"!=this.filter)return!1;if("c"==e.round||"f"==e.round)return e.best>0&&e.pos<=3;var t;for(t=0;t<p[e.event].rounds.length;t++)if(p[e.event].rounds[t].id==e.round&&p[e.event].rounds[t+1])return e.best>0&&e.pos<=p[e.event].rounds[t+1].number;return!1}},components:{"input-panel":{props:["result"],data:function(){return{lastIndex:null,currentIndex:null,competitor:{name:""},value1:0,value2:0,value3:0,value4:0,value5:0,best:0,worst:0,average:0,searchText:"",searching:!1,selectedIndex:0}},computed:{competitors:function(){var e=this,t=e.searchText.toLowerCase();return e.results.filter(e.filterCompetitors.bind(e)).sort(function(e,n){if(!/^\d+$/.test(t)){var r=e.user.name.toLowerCase().indexOf(t)-n.user.name.toLowerCase().indexOf(t);return 0==r&&(r=e.user.name<n.user.name?-1:1),r}return e.number-n.number}).slice(0,5)}},watch:{round:function(){this.searchText=""},event:function(){this.searchText=""},result:function(e){var t=this;t.competitor=e.user,t.value1=e.value1||0,t.value2=e.value2||0,t.value3=e.value3||0,t.value4=e.value4||0,t.value5=e.value5||0,t.searchText=e.number||""},searchText:function(e){this.selectedIndex=0,""==e&&(this.result={})}},attached:function(){var e=this;$(window).on("resize",function(){e.$el.style.width=e.$el.parentNode.clientWidth-30+"px"}).trigger("resize")},methods:{isDisabled:function(e){var t=this,n=t.result;if(!n||!n.id||!this.$parent.isCurrentRoundOpen)return!0;var r=v[m.params.event][m.params.round];if(r.cut_off>0){for(var s="a"==r.format?2:1,a=!1,i=1;s>=i;i++)if(t.result["value"+i]>0&&t.result["value"+i]/100<r.cut_off){a=!0;break}return!(a||s>e)}return!1},keydown:function(e){var t=e.which,n=this;switch(t){case 107:case 40:case 38:case 9:e.shiftKey||107==t||38==t?$(".result-input:not([disabled])").last().focus():$(".result-input:not([disabled])").first().focus();break;case 13:n.save()}},save:function(){var e=this;s(e.result),E.dispatch("UPDATE_RESULT",e.result),d.send({type:"result",action:"update",result:e.result}),e.result={},$("#input-panel-name").focus()},filterCompetitors:function(e){var t=this,n=t.searchText.trim();return""==n?!1:/^\d+$/.test(n)?!!e.number.toString().match(n):!!e.user.name.match(new RegExp(n,"i"))},enter:function(){this.competitors[this.selectedIndex]&&this.selectCompetitor(this.competitors[this.selectedIndex])},up:function(){var e=this.competitors.length;e&&(this.selectedIndex=(this.selectedIndex+e-1)%e)},down:function(){var e=this.competitors.length;e&&(this.selectedIndex=(this.selectedIndex+1)%e)},selectCompetitor:function(e){this.name=e.number,this.$parent.edit(e)}},vuex:{getters:{inputNum:function(e){var t=e.params,n=v[t.event]&&v[t.event][t.round],r=n&&n.format;switch(r){case"1":return 1;case"2":return 2;case"3":case"m":return 3;default:return 5}},minInputNum:function(e){var t=e.params,n=v[t.event]&&v[t.event][t.round],r=n&&n.format;switch(r){case"1":return 1;case"2":return 2;case"3":return 3;case"m":return 1;default:return 2}}}},template:"#input-panel-template",components:{"result-input":{props:["value","index"],data:function(){return{subIndex:2,tried:"",solved:"",time:""}},watch:{time:function(){this.calculateValue()},tried:function(){this.calculateValue()},solved:function(){this.calculateValue()},"$parent.result.id":function(){var e=this,t=i(e.value,e.event);if("333mbf"===e.event)if(e.subIndex=0,t.indexOf("/")>-1){var n=t.match(/^(\d+)\/(\d+) (.+)$/);e.solved=n[1],e.tried=n[2],e.time=n[3].replace(/[:\.]/g,"")}else e.solved=e.tried="",e.time=t;else e.time=t.replace(/[:\.]/g,""),e.subIndex=2}},methods:{calculateValue:function(){var e=this,t=v[m.params.event][m.params.round];e.value=a(e.formatTime(e.time),e.event,!1,e.tried,e.solved),t.time_limit>0&&e.value/100>t.time_limit&&(e.time="DNF"),"333fm"===e.event&&e.value>80&&(e.time="DNF")},formatTime:function(e){if("DNF"==e||"DNS"==e||""==e||"333fm"==this.event)return e;var t=e.length>4?parseInt(e.slice(0,-4)):0,n=e.length>2?parseInt(e.slice(0,-2).slice(-2)):0,r=parseInt(e.slice(-2));if("333mbf"===this.event){if(""==this.solved||""==this.tried)return"";t=n,n=r,r=0}return[t?t+":":"",n+".",r].join("")},focus:function(e){this.subIndex=e,this.$parent.currentIndex=this.index},blur:function(e){this.$parent.currentIndex=null,this.$parent.lastIndex=null},keydown:function(e,t){var n=e.which,r=this,s=r[t];switch(n){case 68:case 111:r.time="DNF";break;case 106:case 83:r.time="DNS";break;case 8:case 109:r.$parent.lastIndex==r.$parent.currentIndex&&"DNF"!=r.time&&"DNS"!=r.time||("DNF"!==r.time&&"DNS"!==r.time||(r.solved=r.tried=r.time=""),s=""),r.$parent.lastIndex=r.$parent.currentIndex,r[t]=s.slice(0,-1);break;case 107:case 38:case 9:if(e.shiftKey||107==n||38==n){var a=$(e.target),i=$(".result-input:not([disabled])"),o=i.index(a);o>0&&i.eq(o-1).focus();break}case 40:case 13:var a=$(e.target),i=$(".result-input:not([disabled])"),o=i.index(a);o<i.length-1?i.eq(o+1).focus():$("#save").focus();break;case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:n-=48;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(s.length>=6)break;if(r.$parent.lastIndex==r.$parent.currentIndex&&"DNF"!=r.time&&"DNS"!=r.time||("DNF"!==r.time&&"DNS"!==r.time||(r.solved=r.tried=r.time=""),s=""),("333fm"===r.event||r.subIndex<2)&&s.length>=2)break;if("333mbf"===r.event&&s.length>=4)break;s+=n-48,r[t]=s,r.$parent.lastIndex!=r.$parent.currentIndex&&(r.$parent.lastIndex=r.$parent.currentIndex);break;default:e.preventDefault()}}},template:"#result-input-template"}}}}}}}),x=new VueRouter;x.map({"/event/:event/:round/:filter":{component:{}}}),E.watch(function(e){return e.params},function(e){x.go(["/event",e.event,e.round,e.filter].join("/")),r()},{deep:!0,sync:!0}),x.afterEach(function(e){var t=e.to.params;t.event==m.params.event&&t.round==m.params.round&&t.filter==m.params.filter||E.dispatch("CHANGE_PARAMS",t)}),x.redirect({"*":["/event",h.event,h.round,m.params.filter].join("/")}),x.start(w,f.get(0))}(this);