!function(e){function t(){u.loading=!0,u.results=[],o.send({type:"result",action:"fetch",params:u.params})}function n(e,t){if(t&&99999==e)return"unknown";e=parseInt(e);var n=Math.floor(e/60),r=Math.floor(n/60);e%=60,n%=60;var s=[e];r>0?s.push(n,r):n>0&&s.push(n);for(var a=1;a<s.length;a++)s[a-1]<10&&(s[a-1]="0"+s[a-1]);return s.reverse().join(":")}function r(e,t){for(var n,r,s=0,o=e.length-1;o>=s;)n=s+o>>1,r=a(t,e[n],!0),0>r?o=n-1:s=n+1;return s}function s(e,t){for(var n=0,r=e.length;r>n;n++)!e[n-1]||a(e[n-1],e[n],!0)<0?e[n].pos=n+1:e[n].pos=e[n-1].pos,0==e[n].best&&(e[n].pos="-"),e[n].isNew=e[n]===t}function a(e,t,n){if(e.average>0&&t.average<=0)return-1;if(t.average>0&&e.average<=0)return 1;var r=e.average-t.average;if(0==r){if(e.best>0&&t.best<=0)return-1;if(t.best>0&&e.best<=0)return 1;r=e.best-t.best}return n||0!=r||(r=e.user.name<t.user.name?-1:1),r}if(!("WS"in e))return void alert("Your browser doesn't support, please upgrade!");var o=new WS("ws://"+location.host+"/ws");o.on("connect",function(){o.send({type:"competition",competitionId:u.competitionId})}).on("newresult",function(e){c.dispatch("NEW_RESULT",e)}).on("newmessage",function(e){l(e)}).on("results",function(e){c.dispatch("UPDATE_RESULTS",e)}),Vue.use(VueRouter),Vue.use(Vuex);var i=$("#live-container"),u={user:{},competitionId:0,events:{},params:{event:"",round:""},loading:!1,results:[],messages:[]},m={ROUTE_CHANGED:function(e,t){e.params=t},NEW_RESULT:function(e,t){if(t.competitionId==e.competitionId&&t.event==e.params.event&&t.round==e.params.round){t.pos="",t.isNew=!0;var n=e.results,a=r(n,t);n.splice(a,0,t),s(n,t)}},UPDATE_RESULT:function(e,t){if(t.competitionId==e.competitionId&&t.event==e.params.event&&t.round==e.params.round){var n=e.results,r=0,o=n.length;for(t.pos="",t.isNew=!0;o>r;r++)if(n[r].id==t.id){n[r]=t;break}n.sort(a),s(n,t)}},UPDATE_RESULTS:function(e,t){t.sort(a),s(t,{}),e.results=t,e.loading=!1},NEW_MESSAGE:function(e,t){e.messages.push(t),e.messages.length>1e3&&e.messages.splice(0,1)}};$.extend(u,i.data());var c=new Vuex.Store({state:u,mutations:m}),p=Vue.extend({template:$("#live-container-template").html(),store:c,components:{chat:Vue.extend({data:function(){return{message:""}},vuex:{getters:{messages:function(e){return e.messages}}},template:$("#chat-template").html(),methods:{send:function(e){var t=this;""!=t.message.trim()&&(o.send({type:"chat",content:t.message}),l({user:u.user,content:t.message,isSelf:!0},!0),t.message="")}},components:{message:Vue.extend({props:["message"],template:$("#message-template").html(),filters:{formatTime:function(e){return e?moment(new Date(1e3*e)).format("HH:mm:ss"):""}}})}}),result:Vue.extend({vuex:{getters:{loading:function(e){return e.loading},results:function(e){return e.results}}},template:$("#result-template").html(),filters:{formatTime:function(e,t){var r;if(e=parseInt(e),-1==e)return"DNF";if(-2==e)return"DNS";if(0==e)return"";if("333fm"===t)r=e>1e3?(e/100).toFixed(2):e;else if("333mbf"===t){var s=99-Math.floor(e/1e7),a=e%100;r=s+a+"/"+(s+2*a)+" "+n(Math.floor(e/100)%1e5,!0)}else{var o=e%100,i=Math.floor(e/100);10>o&&(o="0"+o),r=n(i)+"."+o}return r}}})}}),f=new VueRouter;f.map({"/:event/:round":{component:{}}}),c.watch(function(e){return e.params},function(e){f.go(["",e.event,e.round].join("/")),t()},{deep:!0,sync:!0,immediate:!0}),f.afterEach(function(e){var t=e.to.params;console.log(t,JSON.parse(JSON.stringify(u.params))),t.event==u.params.event&&t.round==u.params.round||c.dispatch("ROUTE_CHANGED",t)}),f.redirect({"*":["",u.params.event,u.params.round].join("/")}),f.start(p,i.get(0));var l=function(){var e=$(".message-container"),t=e.find("ul");return function(n,r){c.dispatch("NEW_MESSAGE",n),(r||e.height()+e.scrollTop()>t.height())&&Vue.nextTick(function(){e.scrollTop(t.height())})}}()}(this);