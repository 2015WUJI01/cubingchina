!function(e){function t(e,t){if(0!=e.best){if(w.alertResult){var n={id:+new Date,type:"result",user:{name:"System"},time:Math.floor(+new Date/1e3),result:e};T(n)}w.alertRecord&&(""!=e.regional_single_record||""!=e.regional_average_record)}}function n(){h.loading||(D.dispatch("LOADING_RESULTS"),m.send({type:"result",action:"fetch",params:{event:h.params.e,round:h.params.r,filter:h.params.filter}}))}function r(e){return g[e.e]}function s(e){return b[e.e][e.r]}function a(e){return R[e]||{}}function i(e){var t,n,r=999999999,a=0,i=!0,o=0,u=0,c=0,l=s(e),f=l.f,d="a"==f||""==f?5:"m"==f?3:parseInt(f);for(t=0;d>t;t++)n=e.v[t],c+=n,n>0&&r>n&&(r=n),0==n&&u++,0>n?(o++,a=n):n>a&&a>=0&&(a=n);e.b=r,999999999===e.b&&(e.b=0==a?0:-1),""==f&&(i=!1),("a"==f||"m"==f)&&u>0&&(i=!1),(o>1||1==o&&("m"==f||"3"==f))&&(i=!1),("1"==f||"2"==f||"3"==f&&"333bf"!=e.e)&&(i=!1),i?("m"==f||"3"==f?("333fm"===e.e&&(c*=100),e.a=Math.round(c/3)):e.a=Math.round((c-r-a)/3),e.a/100>600&&(e.a=100*Math.round(e.a/100))):"m"==f||"a"==f?e.a=u>0?0:-1:"333bf"!=e.event&&""!=f||(e.a=0)}function o(e,t,n,r,s){if("DNF"===e)return-1;if("DNS"===e)return-2;if(""===e)return 0;if("333fm"===t)return n?100*parseFloat(e):parseInt(e);if("333mbf"===t){var a=r-s,i=s-a;if(a>s||2>s)return-1;var o=e.match(/(?:(\d+)?:)?(\d{1,2})/);if(!o)return 0;var u=o[1]?parseInt(o[1]):0,c=parseInt(o[2]);return c=Math.min(60*u+c,600*Math.min(6,r)),1e7*(99-i)+100*c+a}var o=e.match(/(?:(\d+)?:)?(\d{1,2})\.(\d{1,2})/);if(!o)return 0;var u=o[1]?parseInt(o[1]):0,c=parseInt(o[2]),l=parseInt(o[3]);return 60*u+c>600&&(c+=l>50?1:0,l=0),100*(60*u+c)+l}function u(e,t){var n;if(0==e||void 0==e)return"";if(e=parseInt(e),-1==e)return"DNF";if(-2==e)return"DNS";if("333fm"===t)n=e>1e3?(e/100).toFixed(2):e+"";else if("333mbf"===t){var r=99-Math.floor(e/1e7),s=e%100;n=r+s+"/"+(r+2*s)+" "+c(Math.floor(e/100)%1e5,!0)}else{var a=e%100,i=Math.floor(e/100);10>a&&(a="0"+a),n=c(i)+"."+a}return n}function c(e,t){if(t&&99999==e)return"unknown";e=parseInt(e);var n=Math.floor(e/60),r=Math.floor(n/60);e%=60,n%=60;var s=[e];1==r&&(n+=60,r=0),r>0?s.push(n,r):n>0&&s.push(n);for(var a=1;a<s.length;a++)s[a-1]<10&&(s[a-1]="0"+s[a-1]);return s.reverse().join(":")}function l(e,t){for(var n,r,s=0,a=e.length-1;a>=s;)n=s+a>>1,r=d(t,e[n],!0),0>r?a=n-1:s=n+1;return s}function f(e,t){for(var n=0,r=e.length;r>n;n++)!e[n-1]||d(e[n-1],e[n],!0)<0?e[n].p=n+1:e[n].p=e[n-1].p,0==e[n].b&&(e[n].p="-"),e[n].isNew=e[n]===t}function d(e,t,n){var r=0,i=s(e);if("m"==i.f||"a"==i.f){if(e.a>0&&t.a<=0)return-1;if(t.a>0&&e.a<=0)return 1;r=e.a-t.a}if(0==r){if(e.b>0&&t.b<=0)return-1;if(t.b>0&&e.b<=0)return 1;r=e.b-t.b}return n||0!=r||(r=a(e.n).name<a(t.n).name?-1:1),r}if(!("WS"in e))return void alert("Your browser doesn't support, please upgrade!");var m=new WS("ws://"+location.host+"/ws");m.threshold=55e3,m.on("connect",function(){m.send({type:"competition",competitionId:h.c}),0==h.results.length&&n(),m.send({type:"result",action:"rounds"}),w.showMessage&&m.send({type:"chat",action:"fetch"})}).on("*",function(e,t){t&&t.onlineNumber&&D.dispatch("UPDATE_ONLINE_NUMBER",t.onlineNumber)}).on("users",function(e){R=e}).on("result.new",function(e){D.dispatch("NEW_RESULT",e),t(e,"new")}).on("result.update",function(e){D.dispatch("UPDATE_RESULT",e),t(e,"update")}).on("result.user",function(e){D.dispatch("UPDATE_USER_RESULTS",e)}).on("result.all",function(e){D.dispatch("UPDATE_RESULTS",e)}).on("round.all",function(e){D.dispatch("UPDATE_ROUNDS",e)}).on("round.update",function(e){D.dispatch("UPDATE_ROUND",e)}).on("message.recent",function(e){w.showMessage&&D.dispatch("RECENT_MESSAGES",e)}).on("message.new",function(e){w.showMessage&&T(e)}).on("message.disable",function(e){w.disableChat=e}),Vue.use(VueRouter),Vue.use(Vuex),Vue.filter("decodeResult",u);var p=$("#live-container"),h={onlineNumber:0,user:{},c:0,events:[],filters:[],params:{event:"",round:"",filter:"all"},loading:!1,loadingUserResults:!1,results:[],userResults:[],messages:[]},v=Date.now(),g={},b={},R={},E={},N={CHANGE_PARAMS:function(e,t){e.params=t},UPDATE_ROUNDS:function(e,t){t.forEach(function(e){$.extend(b[e.e][e.i],e)}),v=Date.now()},UPDATE_ROUND:function(e,t){$.extend(b[t.e][t.i],t)},NEW_RESULT:function(e,t){if(t.c==e.c&&t.e==e.params.e&&t.r==e.params.r){t.p="",t.isNew=!0;var n=e.results,r=l(n,t);n.splice(r,0,t),f(n,t)}},UPDATE_RESULT:function(e,t){if(t.c==e.c&&t.e==e.params.e&&t.r==e.params.r){var n=e.results,r=0,s=n.length;for(t.p="",t.isNew=!0;s>r;r++)if(n[r].i==t.i){n[r]=t;break}n.sort(d),f(n,t)}},UPDATE_RESULTS:function(e,t){t.sort(d),f(t,{}),e.results=t,e.loading=!1},UPDATE_USER_RESULTS:function(e,t){e.userResults=t,e.loadingUserResults=!1},LOADING_RESULTS:function(e){e.loading=!0,e.results=[]},LOADING_USER_RESULTS:function(e){e.loadingUserResults=!0,e.userResults=[]},RECENT_MESSAGES:function(e,t){var n={};e.messages.forEach(function(e){n[e.id]=e.id}),t.forEach(function(t){t.type="normal",n[t.id]||e.messages.push(t)}),Vue.nextTick(function(){T({},!0)})},NEW_MESSAGE:function(e,t){(t.id||t.isSelf)&&(e.messages.push(t),e.messages.length>1e3&&e.messages.splice(0,1))},UPDATE_ONLINE_NUMBER:function(e,t){e.onlineNumber=t}};$.extend(h,p.data());var w={enableEntry:!0,showMessage:!0,alertResult:!0,alertRecord:!0,disableChat:!1},S=window.store.get("live_options");S&&S.disableChat&&delete S.disableChat,$.extend(w,S),h.events.forEach(function(e){g[e.i]=e,b[e.i]={},e.rs.forEach(function(t){b[e.i][t.i]=t,E.e||2!=t.s||(E.e=e.i,E.r=t.i)})}),E.e||(E={e:h.params.e,r:h.params.r});var x={methods:{getRecordClass:function(e){return"NR"==e||"WR"==e?"record-"+e.toLowerCase():"record-cr"},getEventName:function(e){var t=r(e);return t&&t.name},getRoundName:function(e){var t=s(e);return t&&t.name},getUser:function(e){return a(e)},getResultDetail:function(e){var t,n,r=[];for(t=0;5>t;t++)n=u(e.v[t],e.e),n=(n+"            ").slice(0,"333mbo"===e.e||"333mbf"===e.e?13:8),r.push(n);return"<pre>"+r.join("   ")+"</pre>"}},vuex:{getters:{hasPermission:function(e){var t=e.user;return t.isOrganizer||t.isDelegate||t.isAdmin},eventName:function(e){var t=r(e.params);return t&&t.name},roundName:function(e){var t=s(e.params);return t&&t.name},events:function(e){return e.events},e:function(e){return e.params.e},r:function(e){return e.params.r},currentRound:function(e){return s(e.params)},isCurrentRoundOpen:function(e){var t=s(e.params);return 1!=t.s},results:function(e){return e.results},loading:function(e){return e.loading},userResults:function(e){return e.userResults},loadingUserResults:function(e){return e.loadingUserResults},filters:function(e){return e.filters},onlineNumber:function(e){return e.onlineNumber}}}},D=new Vuex.Store({state:h,mutations:N});Vue.mixin(x);var U=Vue.extend({template:"#live-container-template",store:D,data:function(){return{options:w,currentUser:{}}},watch:{"options.disableChat":function(e){m.send({type:"chat",action:"disable",disable_chat:e})},"options.enableEntry":function(){window.store.set("live_options",this.options)},"options.showMessage":function(){window.store.set("live_options",this.options)},"options.alertResult":function(){window.store.set("live_options",this.options)},"options.alertRecord":function(){window.store.set("live_options",this.options)}},methods:{showOptions:function(){$("#options-modal").modal()}},components:{chat:{props:["options"],data:function(){return{message:""}},vuex:{getters:{messages:function(e){return e.messages}}},template:"#chat-template",methods:{send:function(e){var t=this;""!=t.message.trim()&&(m.send({type:"chat",action:"send",content:t.message,params:h.params}),T({user:h.user,content:t.message,isSelf:!0},!0),t.message="")}},components:{message:{props:["message"],template:"#message-template",filters:{formatTime:function(e){return e?moment(new Date(1e3*e)).format("MM-DD HH:mm:ss"):""}},components:{"normal-message":{props:["message"],template:"#normal-message-template"},"result-message":{props:["message","result"],template:"#result-message-template"}}}}},result:{props:["options"],data:function(){return{eventRound:null,filter:"all",current:{v:[]},co:0,tl:0,f:"",n:0,page:1,limit:300}},computed:{offset:function(){return(this.page-1)*this.limit},totalPage:function(){return Math.ceil(this.results.length/this.limit)}},watch:{"$store.state.params":function(e){var t=this;t.eventRound={e:e.e,r:e.r},t.filter=e.filter,t.page=1;var n=s(e);t.co=n.co,t.tl=n.tl,t.n=n.n,t.f=n.f}},ready:function(){var e=this;e.eventRound={e:E.e,r:E.r};var t=s(e);e.co=t.co,e.tl=t.tl,e.n=t.n,e.f=t.f},template:"#result-template",methods:{hasAverage:function(e){var t=s(e||this);return"a"==t.f||"m"==t.f||"333bf"==t.e&&"3"==t.f},showRoundSettings:function(){$("#round-settings-modal").modal()},saveRoundSettings:function(){var e,t=this,n=["co","tl","n"];for(e=0;e<n.length;e++)if($("#"+n[e]).parent().removeClass("has-error"),isNaN(t[n[e]]))return void $("#"+n[e]).parent().addClass("has-error");return $("#f").parent().removeClass("has-error"),""==t.f?void $("#f").parent().addClass("has-error"):(m.send({type:"result",action:"round",round:{event:h.params.e,id:h.params.r,cut_off:t.co,time_limit:t.tl,format:t.f,number:t.n}}),void $("#round-settings-modal").modal("hide"))},closeRound:function(){this.current={v:[]},m.send({type:"result",action:"round",round:{event:h.params.e,id:h.params.r,status:1}}),n(),$("#round-settings-modal").modal("hide")},openRound:function(){m.send({type:"result",action:"round",round:{event:h.params.e,id:h.params.r,status:0}}),n(),$("#round-settings-modal").modal("hide")},resetCompetitors:function(){confirm("Do you want to reset competitors?")&&m.send({type:"result",action:"reset",round:{event:h.params.e,id:h.params.r}})},goToUser:function(e){this.$parent.currentUser=e,$("#user-results-modal").modal("show"),D.dispatch("LOADING_USER_RESULTS"),m.send({type:"result",action:"user",user:e})},edit:function(e){this.hasPermission&&w.enableEntry&&this.isCurrentRoundOpen&&(this.current=JSON.parse(JSON.stringify(e)),this.$nextTick(function(){$(".input-panel-result input").eq(0).focus()}))},changeParams:function(){D.dispatch("CHANGE_PARAMS",{e:this.eventRound.e,r:this.eventRound.r,filter:this.filter}),Date.now()-v>3e5&&m.send({type:"result",action:"rounds"})},isAdvanced:function(e){if("all"!=this.filter)return!1;if("c"==e.r||"f"==e.r)return e.b>0&&e.p<=3;var t;for(t=0;t<g[e.e].rs.length;t++)if(g[e.e].rs[t].id==e.r&&g[e.e].rs[t+1])return e.b>0&&e.p<=g[e.e].rs[t+1].n;return!1}},components:{"input-panel":{props:["result"],data:function(){return{lastIndex:null,currentIndex:null,competitor:{name:""},v:[0,0,0,0,0],best:0,worst:0,average:0,searchText:"",searching:!1,selectedIndex:0}},computed:{competitors:function(){var e=this,t=e.searchText.toLowerCase();return e.results.filter(e.filterCompetitors.bind(e)).sort(function(e,n){if(!/^\d+$/.test(t)){var r=a(e.n).name.toLowerCase().indexOf(t)-a(n.n).name.toLowerCase().indexOf(t);return 0==r&&(r=a(e.n).name<a(n.n).name?-1:1),r}return e.n-n.n}).slice(0,5)}},watch:{round:function(){this.searchText=""},event:function(){this.searchText=""},result:function(e){var t=this;t.competitor=a(e.n),t.v=e.v,t.searchText=e.n||""},searchText:function(e){this.selectedIndex=0,""==e&&(this.result={v:[]})}},attached:function(){var e=this;$(window).on("resize",function(){e.$el.style.width=e.$el.parentNode.clientWidth-30+"px"}).trigger("resize")},methods:{isDisabled:function(e){var t=this,n=t.result;if(!n||!n.i||!this.$parent.isCurrentRoundOpen)return!0;var r=b[h.params.e][h.params.r];if(r.co>0){for(var s="a"==r.f?2:1,a=!1,i=0;s>i;i++)if(t.result.v[i]>0&&t.result.v[i]/100<r.co){a=!0;break}return!(a||s>e)}return!1},keydown:function(e){var t=e.which,n=this;switch(t){case 107:case 40:case 38:case 9:e.shiftKey||107==t||38==t?$(".result-input:not([disabled])").last().focus():$(".result-input:not([disabled])").first().focus();break;case 13:n.save()}},save:function(){var e=this;i(e.result),D.dispatch("UPDATE_RESULT",e.result);var t=e.result;m.send({type:"result",action:"update",result:{id:t.i,value1:t.v[0],value2:t.v[1],value3:t.v[2],value4:t.v[3],value5:t.v[4],best:t.b,average:t.a}}),e.result={v:[]},$("#input-panel-name").focus()},filterCompetitors:function(e){var t=this,n=t.searchText.trim();return""==n?!1:/^\d+$/.test(n)?!!e.n.toString().match(n):!!a(e.n).name.match(new RegExp(n,"i"))},enter:function(){this.competitors[this.selectedIndex]&&this.selectCompetitor(this.competitors[this.selectedIndex])},up:function(){var e=this.competitors.length;e&&(this.selectedIndex=(this.selectedIndex+e-1)%e)},down:function(){var e=this.competitors.length;e&&(this.selectedIndex=(this.selectedIndex+1)%e)},selectCompetitor:function(e){this.name=e.n,this.$parent.edit(e)}},vuex:{getters:{inputNum:function(e){var t=e.params,n=s(t),r=n&&n.f;switch(r){case"1":return 1;case"2":return 2;case"3":case"m":return 3;default:return 5}},minInputNum:function(e){var t=e.params,n=s(t),r=n&&n.f;switch(r){case"1":return 1;case"2":return 2;case"3":return 3;case"m":return 1;default:return 2}}}},template:"#input-panel-template",components:{"result-input":{props:["value","index"],data:function(){return{subIndex:2,tried:"",solved:"",time:""}},watch:{time:function(){this.calculateValue()},tried:function(){this.calculateValue()},solved:function(){this.calculateValue()},"$parent.result.i":function(){var e=this,t=u(e.value,e.e);if("333mbf"===e.e)if(e.subIndex=0,t.indexOf("/")>-1){var n=t.match(/^(\d+)\/(\d+) (.+)$/);e.solved=n[1],e.tried=n[2],e.time=n[3].replace(/[:\.]/g,"")}else e.solved=e.tried="",e.time=t;else e.time=t.replace(/[:\.]/g,""),e.subIndex=2}},methods:{calculateValue:function(){var e=this,t=s(e);e.value=o(e.formatTime(e.time),e.e,!1,e.tried,e.solved),t.tl>0&&"333mbf"!=e.e&&"333fm"!=e.e&&e.value/100>t.tl&&(e.time="DNF"),"333fm"===e.e&&e.value>80&&(e.time="DNF")},formatTime:function(e){if("DNF"==e||"DNS"==e||""==e||"333fm"==this.e)return e;var t=e.length>4?parseInt(e.slice(0,-4)):0,n=e.length>2?parseInt(e.slice(0,-2).slice(-2)):0,r=parseInt(e.slice(-2));if("333mbf"===this.e){if(""==this.solved||""==this.tried)return"";t=n,n=r,r=0}return[t?t+":":"",n+".",r].join("")},focus:function(e){this.subIndex=e,this.$parent.currentIndex=this.index},blur:function(e){this.$parent.currentIndex=null,this.$parent.lastIndex=null},keydown:function(e,t){var n=e.which,r=this,s=r[t],a=r.$parent.lastIndex==r.$parent.currentIndex;switch(n){case 68:case 111:r.time="DNF";break;case 106:case 83:r.time="DNS";break;case 8:case 109:a&&"DNF"!=r.time&&"DNS"!=r.time||("DNF"!==r.time&&"DNS"!==r.time||(r.solved=r.tried=r.time=""),s=""),r.$parent.lastIndex=r.$parent.currentIndex,r[t]=s.slice(0,-1);break;case 107:case 38:case 9:if(e.shiftKey||107==n||38==n){var i=$(e.target),o=$(".result-input:not([disabled])"),u=o.index(i);u>0&&o.eq(u-1).focus();break}case 40:case 13:var i=$(e.target),o=$(".result-input:not([disabled])"),u=o.index(i);u<o.length-1?o.eq(u+1).focus():$("#save").focus();break;case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:n-=48;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(s.length>=6&&a)break;if(a&&"DNF"!=r.time&&"DNS"!=r.time||("DNF"!==r.time&&"DNS"!==r.time||(r.solved=r.tried=r.time=""),s=""),("333fm"===r.e||r.subIndex<2)&&s.length>=2)break;if("333mbf"===r.e&&s.length>=4)break;s+=n-48,r[t]=s,a||(r.$parent.lastIndex=r.$parent.currentIndex);break;default:e.preventDefault()}}},template:"#result-input-template"}}}}}}}),I=new VueRouter;I.map({"/event/:e/:r/:filter":{component:{}}}),D.watch(function(e){return e.params},function(e){I.go(["/event",e.e,e.r,e.filter].join("/")),n()},{deep:!0,sync:!0}),I.afterEach(function(e){var t=e.to.params;t.e==h.params.e&&t.r==h.params.r&&t.filter==h.params.filter||D.dispatch("CHANGE_PARAMS",t)}),I.redirect({"*":["/event",E.e,E.r,h.params.filter].join("/")}),I.start(U,p.get(0));var T=function(){var e=$(".message-container"),t=e.find("ul");return function(n,r){0==e.length&&(e=$(".message-container"),t=e.find("ul")),n.type=n.type||"normal",D.dispatch("NEW_MESSAGE",n),(r||e.height()+e.scrollTop()>t.height()-30)&&Vue.nextTick(function(){e.scrollTop(t.height())})}}()}(this);